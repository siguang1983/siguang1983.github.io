<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Mongoose | 大排档</title>
    <meta name="author" content="siguang(厨子)" />
    <meta name="version" content="1.0.0" />
    <meta name="keywords" content="" />
    <meta name="description" content="概念Schema[ˈskimə] - 数据库存储格式的约定协议，可以理解为数据表的字段类型声明。

Model -  由Schema转化的数据模型，具有抽象属性和行为的数据库操作，可以进行查询操作

Entity [ˈɛntɪti] - 由Model创建的实体，可以对数据库表进行完整的CRUD操作
Mongoose使用一、安装 

    $ npm install mongoose      

二、引用

    const mongoose = require(&amp;apos;mongoose" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
    <meta name="baidu-site-verification" content="F0CXvmUgA9" />

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/EggJS/">EggJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP详解/">HTTP详解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Less/">Less</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Native/">React Native</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sass/">Sass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Weex/">Weex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mock数据/">mock数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数式编程/">函数式编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端优化/">前端优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端插件类/">前端插件类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端构建工具/">前端构建工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微信小程序/">微信小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/插件/">插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务器/">服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务端开发/">服务端开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模板引擎/">模板引擎</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/浏览器内核/">浏览器内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/移动端/">移动端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/经济学/">经济学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/金融/">金融</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">归档</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/atom.xml">订阅</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/about">关于</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://siguang1983.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#概念"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mongoose使用"><span class="toc-number">2.</span> <span class="toc-text">Mongoose使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#连接"><span class="toc-number">3.</span> <span class="toc-text">连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Schema"><span class="toc-number">4.</span> <span class="toc-text">Schema</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Schema-Type"><span class="toc-number">5.</span> <span class="toc-text">Schema Type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Model"><span class="toc-number">6.</span> <span class="toc-text">Model</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询"><span class="toc-number">7.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除"><span class="toc-number">8.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更新"><span class="toc-number">9.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Entity"><span class="toc-number">10.</span> <span class="toc-text">Entity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#save"><span class="toc-number">11.</span> <span class="toc-text">save()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-mongose"><span class="toc-number">12.</span> <span class="toc-text">egg-mongose</span></a></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            Mongoose
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2017/04/02/mongoose/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-04-02T11:15:23.000Z" itemprop="datePublished">2017-04-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/数据库/">数据库</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><pre><code>Schema[ˈskimə] - 数据库存储格式的约定协议，可以理解为数据表的字段类型声明。

Model -  由Schema转化的数据模型，具有抽象属性和行为的数据库操作，可以进行查询操作

Entity [ˈɛntɪti] - 由Model创建的实体，可以对数据库表进行完整的CRUD操作
</code></pre><h4 id="Mongoose使用"><a href="#Mongoose使用" class="headerlink" title="Mongoose使用"></a>Mongoose使用</h4><pre><code>一、安装 

    $ npm install mongoose      

二、引用

    const mongoose = require(&apos;mongoose&apos;);

    // connect()创建一个数据库连接
    let db = mongoose.connect(&apos;mongodb://car:welcomeCar@localhost/myCar&apos;);          // mongodb://用户名:密码@数据库IP/库名

    db.on(&apos;error&apos;, console.error.bind(console, &apos;connection error:&apos;));   // 连接失败
    db.once(&apos;open&apos;, function (callback) {    
        // yay! 连接成功
    });

    // 定义Schema文档结构
    let Schema = mongoose.Schema;
    let carSchema = new Schema({
        id: Number,
        carName: String,
        carPrice: Nuber,
        date: {type: Date, default: Date.now}
    })

    // 定义Model模型
    let carMode = db.model(&apos;cars&apos;, carSchema);

    // 定义一个Entity
    let carEntity = new carMode({
        id: 1,
        carName: &apos;路虎&apos;,
        carPrice: 700000
    })

    // 存储
    carEntity.save(function(err){
        if(err){
            console.log(&apos;存储错误&apos;)
        }
    })

    // 查找
    carMode.find({carName: &apos;路虎&apos;}, function(err, doc){
        if(err){
            console.log(err)
        }
        else{
            console.log(doc);
        }
    })
</code></pre><h4 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h4><pre><code>mongoose两种连接： connect连单个db并打开，createConnect连接多个db

一、mongoose.connect()方法连接

    写法1:
        connect(&apos;mongodb://[username]:[password]@host:port/database?options...&apos;);   // 用户名、密码、主机、端口、库名、参数

        let db = mongoose.connect(&apos;mongodb://[username]:[password]@127.0.0.1:27017/myDB&apos;);


    写法2:
        -- conect(uri, options) --

        var options = {
            db: { native_parser: true },
            server: { poolSize: 5 },
            replset: { rs_name: &apos;myReplicaSetName&apos; },
            user: &apos;myUserName&apos;,
            pass: &apos;myPassword&apos;
        }
        var uri = &apos;mongodb://localhost/dbName?poolSize=4&apos;;
        mongoose.connect(uri, options);


二、多个连接

    -- mongoose.createConnection() --

    let mongoose = require(&apos;mongoose&apos;);
    let db = mongoose.connect(&apos;mongodb://127.0.0.1:27017/myDB&apos;);        // mongodb://IP:端口号/数据库名

    // 侦听打开的回调
    db.connection.on(&apos;error&apos;, function(error){
        console.log(&apos;数据库连接失败&apos;+error);
    })

    // 侦听连接成功
    db.connection.on(&apos;open&apos;, function(){
        console.log(&apos;连接成功&apos;)
    })


三、两者的区别

    var mongoose = require(&apos;mongoose&apos;);
    db = mongoose.createConnection(&apos;localhost&apos;, &apos;test&apos;);
    var schema = new mongoose.Schema({ name: String });
    var collectionName = &apos;kittens&apos;;
    var M = db.model(&apos;Kitten&apos;, schema, collectionName);

    var mongoose = require(&apos;mongoose&apos;);
    mongoose.connect(&apos;mongodb://localhost/test&apos;);
    db = mongoose.connection;
    db.once(&apos;open&apos;, function callback () {
        // yay!
    });    

    createConnection，可以open，但完全不会查询。第二种方法就可以
</code></pre><h4 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h4><pre><code>Schema: 一种文件形式存储数据库模型的骨架，无法直接连接数据端，不具备操作数据库的能力，叫数据属性模型或集合

let personSchema = new mongoose.Schema({
    name: String,
    age: Number,
    email: String
})

二、实例方法

三、静态方法

四、indexes 索引

创建规则

    let Schema = mongoose.Schema;
    let carSchema = new Schema({
        name: String,
        title: { type: String, index: true },   // index 索引
        uid: { type: Number, unique: true },    // unique 独一无二的
        date: { type: Date, default: Date.now } // default 默认值
    })

    // 文档索引和字段索引
    let carSchema = new Schema({
        name: String,
        title: { type: [String], index: true },   // 字段索引
    })

    carSchema.index({ name: 1, type: -1});  // 
</code></pre><h4 id="Schema-Type"><a href="#Schema-Type" class="headerlink" title="Schema Type"></a>Schema Type</h4><pre><code>一、类型

    String：字符串
    Number：数值
    Date：日期
    Buffer： 二进制
    Boolean：布尔
    Mixed： 混合
    ObjectId： ObjectId
    Array：数组

二、其它参数

    default: 默认         // updated: { type: Date, default: Date.now }

    min/max: 最小或最大    // age: { type: Number, min: 18, max: 65 }

    trim: 去掉两端空格

    unique: true 指定字段为独一无二

三、Example

    var schema = new Schema({
        name:    String,
        binary:  Buffer,
        living:  Boolean,
        updated: { type: Date, default: Date.now }
        age:     { type: Number, min: 18, max: 65 }
        mixed:   Schema.Types.Mixed,
        _someId: Schema.Types.ObjectId,
        array:      [],
        ofString:   [String],
        ofNumber:   [Number],
        ofDates:    [Date],
        ofBuffer:   [Buffer],
        ofBoolean:  [Boolean],
        ofMixed:    [Schema.Types.Mixed],
        ofObjectId: [Schema.Types.ObjectId],
        nested: {
            stuff: { type: String, lowercase: true, trim: true }
        }
    })
</code></pre><h4 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h4><pre><code>具有操作数据库的能力，类似管理数据库的属性和行的类

创建model  mongoose.model(&apos;集合名&apos;, schema);

    let personScheam = new Scheam({
        name: &apos;String&apos;,
        password: &apos;String&apos;
    }, {
        timestamps: true,             // 设置timestamps，多加两个字段createdTime、updatedTime，来记录插入时间和更新时间
        collection: &apos;report_warning_config&apos;,
    })

    let personModel = mongoose.model(&apos;person&apos;, personSchema);
</code></pre><h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><pre><code>一、find, findById, findOne, or where 

    let TankScheam = new Scheam({
        name: &apos;String&apos;,
        password: &apos;String&apos;
    })

    let Tank = mongoose.model(&apos;Tank&apos;, personSchema);

    Tank.find({size: &apos;samll&apos;}).where(&apos;createDate&apos;).gt(oneYear).exec(callback);

二、条件查询中常用属性

    $or　　　　或关系
    $nor　　　　或关系取反
    $gt　　　　大于
    $gte　　　　大于等于
    $lt　　　　小于
    $lte　　　　小于等于
    $ne　　　　不等于
    $in　　　　在多个值范围内
    $nin　　　　不在多个值范围内
    $all　　　　匹配数组中多个值
    $regex　　　　正则，用于模糊查询
    $size　　　　匹配数组大小
    $maxDistance　　　　范围查询，距离（基于LBS）
    $mod　　　　取模运算
    $near　　　　邻域查询，查询附近的位置（基于LBS）
    $exists　　　　字段是否存在
    $elemMatch　　　　匹配内数组内的元素
    $within　　　　范围查询（基于LBS）
    $box　　　　范围查询，矩形范围（基于LBS）
    $center　　　　范围醒询，圆形范围（基于LBS）
    $centerSphere　　　　范围查询，球形范围（基于LBS）
    $slice　　　　查询字段集合中的元素（比如从第几个之后，第N到第M个元素


三、方法

    1、where(&apos;price&apos;) - 查询的字段  Tank.find().where(&apos;price&apos;)

    2、find() - 查询所有，返回的是数组

    3、findOne({name: &apos;siguang&apos;}) - 只把第一条name为siguang的数据，如果find会将所有都返回

    4、findById(id) - 根据一条id来查找，返回的是一条记录的对象，而不是一个数组，与find({_id: &apos;59bf7ee03f55167fb6cdd75c&apos;})相同

    5、findByIdAndRemove(id) - 根据id查找，并删除这个条数据，如果查找不到返回 null

    6、findByIdAndUpdate(id, update) - 

    7、lean() - Tank.find().lean()      // 默认参数为true, 可以设置 lean(false)
</code></pre><h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h4><pre><code>Tank.remove({size: &apos;large&apos;})

// 查找并删除
Tank.findByAndRemove()
</code></pre><h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><pre><code>Tank.update({_id: id}, {$set: {size: &apos;large&apos;}, callback);

// 查找并更新
Tank.findByIdAndUpdate(id, [update]);
</code></pre><h4 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h4><h4 id="save"><a href="#save" class="headerlink" title="save()"></a>save()</h4><pre><code>insert和update都需要save(),
</code></pre><h4 id="egg-mongose"><a href="#egg-mongose" class="headerlink" title="egg-mongose"></a>egg-mongose</h4><pre><code>1、在model中创建模型

    module.exports = app =&gt; {
        const mongoose = app.mongoose;

        const NewsSchema = new mongoose.Schema({
            newsTitle: {type: String, max: 32},
            newsContent: {type: String},
        },{
            timestamps: true,               // 插入记录时会自动创建一个createAt和updateAt时间字段
            collection: &apos;news&apos;,             // mongo中存的collection名
        });

        return mongoose.model(&apos;News&apos;, NewsSchema);      // News调用时的名
    }


2、在service中调用

    let doc = await app.model.News.find();

3、创建和查询

    const doc = await new app.model.User(user).save();          // 创建时需要new 

    const user = await app.model.User.findOne({_id: user._id});     // 查询时不需要new


4、使用find()查询 使用. ()

    如果使用find().lean()返回的是纯javascript对象，而不是mongoose文档，他们没有保存方法

    Example:

    const resourceTree = await app.model.Resource.find({});

        返回
        { _id: 5a535142fe6d170e82135e89,
            displayName: &apos;欢欢&apos;,
            username: &apos;huanhuan&apos;,
            mobile: 13012309874,
            email: &apos;huan@126.com&apos; 
        },
        { _id: 5a5357d2bd53b40f791362aa,
            username: &apos;maolv&apos;,
            displayName: &apos;毛驴&apos;,
            mobile: 13290984585,
            email: &apos;maolv@126.com&apos; 
        }

    const resourceTree = await app.model.Resource.find({}).lean();

        返回
        [
            { _id: 5a535142fe6d170e82135e89,
                displayName: &apos;欢欢&apos;,
                username: &apos;huanhuan&apos;,
                mobile: 13012309874,
                email: &apos;huan@126.com&apos; 
            },
            { _id: 5a5357d2bd53b40f791362aa,
                username: &apos;maolv&apos;,
                displayName: &apos;毛驴&apos;,
                mobile: 13290984585,
                email: &apos;maolv@126.com&apos; 
            }
        ]
</code></pre><blockquote>
<p><a href="http://www.nodeclass.com/api/mongoose.html" target="_blank" rel="noopener">http://www.nodeclass.com/api/mongoose.html</a><br><a href="https://github.com/eggjs/egg-mongoose" target="_blank" rel="noopener">https://github.com/eggjs/egg-mongoose</a>         egg-mongoose<br><a href="http://cnodejs.org/topic/504b4924e2b84515770103dd" target="_blank" rel="noopener">http://cnodejs.org/topic/504b4924e2b84515770103dd</a><br><a href="http://www.cnblogs.com/xuange306/p/4603551.html" target="_blank" rel="noopener">http://www.cnblogs.com/xuange306/p/4603551.html</a><br><a href="http://www.cnblogs.com/winyh/p/6682039.html" target="_blank" rel="noopener">http://www.cnblogs.com/winyh/p/6682039.html</a><br><a href="http://cnodejs.org/topic/504b4924e2b84515770103dd" target="_blank" rel="noopener">http://cnodejs.org/topic/504b4924e2b84515770103dd</a></p>
</blockquote>

        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://siguang1983.github.io/2017/04/02/mongoose/';
        this.page.title = 'Mongoose';
        this.page.identifier = '2017/04/02/mongoose/';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript" src="/js/scrollspy.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
            $(document.body).scrollspy({target: '#aside-inner'});
            
        });
    </script>

</body>
</html>
